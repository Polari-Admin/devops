# پاکسازی لاگ کانتینرهای Docker با دستور `truncate`

گاهی اوقات فایل‌های لاگ کانتینرهای Docker در مسیر `/var/lib/docker/containers/` بسیار بزرگ می‌شوند و فضای دیسک را اشغال می‌کنند. دستور زیر برای خالی‌کردن این فایل‌ها استفاده می‌شود:

```bash
sh -c 'truncate -s 0 /var/lib/docker/containers/*/*-json.log'
```

---

## شرح جزء به جزء دستور

### 1. اجرای شل
```bash
sh -c '...'
```
این بخش باعث می‌شود که یک شل (`sh`) اجرا شود و دستوری که داخل کوتیشن `'...'` قرار دارد، در آن شل اجرا گردد.

---

### 2. دستور `truncate`
```bash
truncate -s 0 FILE
```
- ابزار `truncate` برای تغییر اندازه‌ی فایل‌هاست.  
- آپشن `-s 0` اندازه فایل را به **صفر بایت** تغییر می‌دهد.  
- این کار باعث می‌شود محتوای فایل حذف شود، اما خود فایل همچنان وجود داشته باشد.

---

### 3. مسیر فایل‌های لاگ
```bash
/var/lib/docker/containers/*/*-json.log
```
- Docker برای هر کانتینر یک دایرکتوری در مسیر زیر ایجاد می‌کند:
  ```
  /var/lib/docker/containers/<container-id>/
  ```
- در هر دایرکتوری، فایلی به نام:
  ```
  <container-id>-json.log
  ```
  وجود دارد.  
- این فایل همان لاگ‌های **stdout** و **stderr** کانتینر است.

---

## نتیجه اجرای دستور

- تمام فایل‌های لاگ `*-json.log` مربوط به کانتینرها خالی (۰ بایت) می‌شوند.  
- هیچ فایلی حذف نمی‌شود و خود کانتینرها هم آسیبی نمی‌بینند.  
- فقط فضای اشغال‌شده توسط لاگ‌ها آزاد خواهد شد.

---

## چرا این دستور استفاده می‌شود؟

- کانتینرهایی که لاگ زیادی تولید می‌کنند، می‌توانند فایل لاگ بسیار بزرگی بسازند (گاهی چند گیگابایت).  
- Docker به صورت پیش‌فرض **Log Rotation** ندارد، بنابراین فایل‌های لاگ دائما بزرگ و بزرگ‌تر می‌شوند.  
- این دستور یک راه‌حل سریع برای آزادسازی فضای دیسک است.

---

## نکات مهم ⚠️

- این روش فقط **پاک‌کردن دستی لاگ‌ها** است. اگر کانتینر همچنان فعال باشد، فایل لاگ مجدداً پر خواهد شد.  
- برای جلوگیری از رشد بی‌رویه لاگ‌ها، بهتر است **Log Rotation** را در Docker تنظیم کنید.

---

## راه‌حل بهتر: فعال‌سازی Log Rotation

برای فعال‌سازی چرخش لاگ‌ها (Log Rotation) در Docker، فایل زیر را ایجاد یا ویرایش کنید:

```bash
/etc/docker/daemon.json
```

محتوای پیشنهادی:

```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

### توضیح پارامترها
- **`log-driver`**: مشخص می‌کند Docker از چه درایوری برای مدیریت لاگ استفاده کند (اینجا `json-file`).  
- **`max-size`**: حداکثر اندازه هر فایل لاگ. وقتی به این مقدار رسید، فایل جدید ساخته می‌شود. (اینجا ۱۰ مگابایت)  
- **`max-file`**: تعداد فایل‌های لاگ نگه‌داری‌شده برای هر کانتینر. (اینجا ۳ فایل)

---

## اعمال تغییرات

پس از ویرایش فایل کانفیگ، سرویس Docker را ری‌استارت کنید:

```bash
sudo systemctl restart docker
```

---

## جمع‌بندی ✅

- دستور `truncate` یک راه سریع برای **خالی‌کردن لاگ‌ها**ست.  
- راه‌حل بلندمدت و امن‌تر: **راه‌اندازی Log Rotation** با تنظیمات `daemon.json`.  
- با این کار، لاگ‌ها همیشه مدیریت‌شده خواهند بود و فضای دیسک بیهوده مصرف نمی‌شود.
